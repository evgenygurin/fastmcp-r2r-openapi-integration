# –ú–Ω–æ–≥–æ—Å–ª–æ–π–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ FastMCP –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π

## üìñ –ö–æ–Ω—Ü–µ–ø—Ü–∏—è

FastMCP —Ä–µ–∞–ª–∏–∑—É–µ—Ç **—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—É—é –º–Ω–æ–≥–æ—Å–ª–æ–π–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É** –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è MCP —Å–µ—Ä–≤–µ—Ä–æ–≤, –≥–¥–µ –∫–∞–∂–¥—ã–π —Å–ª–æ–π –∏–º–µ–µ—Ç —á–µ—Ç–∫—É—é –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å –∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤—É–µ—Ç —á–µ—Ä–µ–∑ –∫–æ–º–ø–æ–∑–∏—Ü–∏—é —Ñ—É–Ω–∫—Ü–∏–π, –∞ –Ω–µ —á–µ—Ä–µ–∑ –∏–µ—Ä–∞—Ä—Ö–∏–∏ –∫–ª–∞—Å—Å–æ–≤.

### –ë–∞–∑–æ–≤–∞—è —á–µ—Ç—ã—Ä–µ—Ö—É—Ä–æ–≤–Ω–µ–≤–∞—è –º–æ–¥–µ–ª—å

```text
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         Presentation Layer              ‚îÇ  ‚Üê Tools, Resources, Prompts
‚îÇ  (MCP Components - LLM Interface)       ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Business Logic Layer            ‚îÇ  ‚Üê Middleware, Pipelines, Context
‚îÇ  (Processing, Auth, Validation)         ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Data Access Layer               ‚îÇ  ‚Üê HTTP Clients, OpenAPI, Databases
‚îÇ  (External APIs, Storage)               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ         Transport Layer                 ‚îÇ  ‚Üê stdio / HTTP / SSE
‚îÇ  (Communication Protocol)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

## üéØ –°–ª–æ–∏ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã

### 1. Presentation Layer (–°–ª–æ–π –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è LLM - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ß–¢–û –¥–æ—Å—Ç—É–ø–Ω–æ.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Tools** - –¥–µ–π—Å—Ç–≤–∏—è, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–µ—Ç –≤—ã–ø–æ–ª–Ω–∏—Ç—å LLM
- **Resources** - –¥–∞–Ω–Ω—ã–µ –¥–ª—è —á—Ç–µ–Ω–∏—è
- **Prompts** - –ø–µ—Ä–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ —à–∞–±–ª–æ–Ω—ã

**–ü—Ä–∏–º–µ—Ä:**

```python
from fastmcp import FastMCP, Context

mcp = FastMCP("My Server")

@mcp.tool(
    description="Enhanced search with progress reporting",
    tags={"search", "rag"}
)
async def enhanced_search(
    query: str,
    limit: int = 10,
    use_hybrid_search: bool = True,
    ctx: Context | None = None
) -> dict[str, Any]:
    """Semantic search with progress and context logging."""
    if ctx:
        await ctx.info(f"Starting search for: {query}")
        await ctx.report_progress(0, 100, "Initializing search...")

    # –î–µ–ª–µ–≥–∞—Ü–∏—è –∫ business logic layer
    response = await _client.post(
        "/v3/retrieval/search",
        json={
            "query": query,
            "limit": limit,
            "use_hybrid_search": use_hybrid_search
        }
    )

    if ctx:
        await ctx.report_progress(100, 100, "Search completed")

    return response.json()
```

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ docstrings –¥–ª—è LLM –ø–æ–Ω–∏–º–∞–Ω–∏—è
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è (`type hints`)
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π `Context`: `ctx: Context | None = None`
- ‚úÖ Annotations –¥–ª—è –ø–æ–¥—Å–∫–∞–∑–æ–∫: `readOnlyHint`, `destructiveHint`, `idempotentHint`
- ‚úÖ –ú–∏–Ω–∏–º—É–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏ (–¥–µ–ª–µ–≥–∞—Ü–∏—è –∫ pipelines)

**–ß—Ç–æ –ù–ï –¥–µ–ª–∞—Ç—å:**
- ‚ùå –°–ª–æ–∂–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –≤ tools
- ‚ùå –ü—Ä—è–º—ã–µ database/HTTP –∑–∞–ø—Ä–æ—Å—ã (–∏—Å–ø–æ–ª—å–∑—É–π data access layer)
- ‚ùå –•–∞—Ä–¥–∫–æ–¥–∏–Ω–≥ credentials

---

### 2. Business Logic Layer (–°–ª–æ–π –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –û–±—Ä–∞–±–æ—Ç–∫–∞, –≤–∞–ª–∏–¥–∞—Ü–∏—è, —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ö–ê–ö –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –ª–æ–≥–∏–∫–∞.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **Middleware** - pipeline –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
- **Pipelines** - –∫–æ–º–ø–æ–∑–∏—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
- **Context** - dependency injection
- **Validators** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–∞–Ω–Ω—ã—Ö

#### 2.1 Middleware (–¶–µ–ø–æ—á–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏)

```python
from fastmcp.server.middleware import Middleware, MiddlewareContext

class LoggingMiddleware(Middleware):
    async def on_call_tool(self, context: MiddlewareContext, call_next):
        start_time = datetime.now()
        tool_name = getattr(context.message, "name", "unknown")

        logger.info(f"‚Üí Tool call started: {tool_name}")

        try:
            result = await call_next(context)
            duration = (datetime.now() - start_time).total_seconds()
            logger.info(f"‚úì Tool completed: {tool_name} ({duration:.2f}s)")
            return result
        except Exception as e:
            duration = (datetime.now() - start_time).total_seconds()
            logger.error(f"‚úó Tool failed: {tool_name} ({duration:.2f}s) - {e}")
            raise

# –î–æ–±–∞–≤–ª–µ–Ω–∏–µ middleware
mcp.add_middleware(LoggingMiddleware())
```

**Execution flow:**

```text
Request
   ‚Üì
Middleware 1 ‚Üí before (Logging)
   ‚Üì
Middleware 2 ‚Üí before (Authentication)
   ‚Üì
Middleware 3 ‚Üí before (Validation)
   ‚Üì
Handler (Tool/Resource)
   ‚Üì
Middleware 3 ‚Üí after (Transform response)
   ‚Üì
Middleware 2 ‚Üí after (Audit)
   ‚Üì
Middleware 1 ‚Üí after (Metrics)
   ‚Üì
Response
```

#### 2.2 Pipelines (–ö–æ–º–ø–æ–∑–∏—Ü–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π)

```python
class Pipeline:
    """Chainable async operations."""

    def __init__(self, ctx: Context | None = None):
        self.ctx = ctx
        self.steps: list[tuple[str, callable, dict]] = []
        self._results: dict[str, Any] = {}

    def add_step(
        self,
        name: str,
        func: callable,
        **kwargs
    ) -> "Pipeline":
        """Add step to pipeline (chainable)."""
        self.steps.append((name, func, kwargs))
        return self  # Fluent interface

    async def execute(self) -> dict[str, Any]:
        """Execute all steps sequentially."""
        for step_name, func, kwargs in self.steps:
            if self.ctx:
                await self.ctx.info(f"Pipeline step: {step_name}")

            # Context propagation
            if "ctx" in func.__code__.co_varnames:
                kwargs["ctx"] = self.ctx

            # Result propagation
            if "previous_results" in func.__code__.co_varnames:
                kwargs["previous_results"] = self._results

            # Execute step
            self._results[step_name] = await func(**kwargs)

        return self._results

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ
pipeline = Pipeline(ctx)
results = await (
    pipeline
    .add_step("search", pipeline_search, query="AI safety")
    .add_step("analyze", pipeline_analyze)
    .add_step("summarize", pipeline_summarize)
    .execute()
)
```

#### 2.3 Context (Dependency Injection)

```python
@mcp.tool
async def advanced_tool(query: str, ctx: Context) -> dict:
    """Tool with full context access."""

    # List resources
    resources = await ctx.list_resources()

    # Read specific resource
    content = await ctx.read_resource("resource://config")

    # LLM sampling
    analysis = await ctx.sample(
        messages=f"Analyze: {query}",
        system_prompt="You are a data analyst",
        temperature=0.3
    )

    # Logging
    await ctx.info(f"Processed query: {query}")
    await ctx.debug(f"Found {len(resources)} resources")

    # Progress reporting
    await ctx.report_progress(50, 100)

    return {
        "query": query,
        "analysis": analysis.text,
        "resources_count": len(resources)
    }
```

---

### 3. Data Access Layer (–°–ª–æ–π –¥–æ—Å—Ç—É–ø–∞ –∫ –¥–∞–Ω–Ω—ã–º)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ —Å –≤–Ω–µ—à–Ω–∏–º–∏ —Å–∏—Å—Ç–µ–º–∞–º–∏ - –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç –ì–î–ï —Ö—Ä–∞–Ω—è—Ç—Å—è –¥–∞–Ω–Ω—ã–µ.

**–ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã:**
- **HTTP Clients** - API –∑–∞–ø—Ä–æ—Å—ã
- **OpenAPI Integration** - auto-generated clients
- **Databases** - persistence
- **Authentication** - credentials management

#### 3.1 DynamicBearerAuth (Request-time authentication)

```python
import httpx
import os

class DynamicBearerAuth(httpx.Auth):
    """Auth handler that reads API key at REQUEST TIME.

    –ö–†–ò–¢–ò–ß–ù–û –¥–ª—è FastMCP Cloud/serverless:
    - –ß–∏—Ç–∞–µ—Ç R2R_API_KEY –ø—Ä–∏ –í–´–ü–û–õ–ù–ï–ù–ò–ò –∑–∞–ø—Ä–æ—Å–∞
    - –ù–ï –ø—Ä–∏ –∏–º–ø–æ—Ä—Ç–µ –º–æ–¥—É–ª—è (–∫–æ–≥–¥–∞ env vars –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω—ã)
    """

    def auth_flow(self, request: httpx.Request):
        """Inject Bearer token at request time."""
        api_key = os.getenv("R2R_API_KEY", "")
        if api_key:
            request.headers["Authorization"] = f"Bearer {api_key}"
        yield request

# Create HTTP client
_client = httpx.AsyncClient(
    base_url="https://api.example.com",
    auth=DynamicBearerAuth(),  # ‚Üê Request-time auth
    timeout=30.0
)
```

**–ü–æ—á–µ–º—É request-time –≤–∞–∂–Ω–æ:**
- ‚úÖ Serverless/cloud –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–Ω–∂–µ–∫—Ç—è—Ç env vars –ü–û–°–õ–ï –∏–º–ø–æ—Ä—Ç–∞ –º–æ–¥—É–ª—è
- ‚úÖ Secrets rotation –±–µ–∑ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞
- ‚úÖ Multi-tenancy —Å —Ä–∞–∑–Ω—ã–º–∏ credentials

#### 3.2 OpenAPI Auto-generation

```python
from fastmcp import FastMCP
import httpx

# –ó–∞–≥—Ä—É–∑–∫–∞ OpenAPI spec
spec = httpx.get("https://api.example.com/openapi.json").json()

# –°–æ–∑–¥–∞–Ω–∏–µ HTTP client
client = httpx.AsyncClient(
    base_url="https://api.example.com",
    auth=DynamicBearerAuth()
)

# Auto-generate MCP server from OpenAPI
mcp = FastMCP.from_openapi(
    openapi_spec=spec,
    client=client,
    route_maps=[
        # GET with params ‚Üí RESOURCE_TEMPLATE
        RouteMap(
            methods=["GET"],
            pattern=r"^/v3/.*\{.*\}.*$",
            mcp_type=MCPType.RESOURCE_TEMPLATE,
        ),
        # GET without params ‚Üí RESOURCE
        RouteMap(
            methods=["GET"],
            pattern=r"^/v3/.*$",
            mcp_type=MCPType.RESOURCE,
        ),
        # POST/PUT/DELETE ‚Üí TOOL
        RouteMap(
            methods=["POST", "PUT", "PATCH", "DELETE"],
            pattern=r".*",
            mcp_type=MCPType.TOOL,
        ),
    ]
)
```

---

### 4. Transport Layer (–°–ª–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞)

**–û—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç—å:** –ö–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Å–µ—Ä–≤–µ—Ä–æ–º.

**–¢–∏–ø—ã —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤:**
- **stdio** - –ª–æ–∫–∞–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ (Claude Desktop)
- **HTTP** - —É–¥–∞–ª–µ–Ω–Ω—ã–π –¥–æ—Å—Ç—É–ø
- **SSE** - streaming responses

```python
# stdio transport (local)
if __name__ == "__main__":
    mcp.run(transport="stdio")

# HTTP transport (remote)
if __name__ == "__main__":
    mcp.run(transport="http", host="0.0.0.0", port=8000)
```

---

## üèõÔ∏è –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è –∫–æ–¥–∞

### –ü—Ä–æ—Å—Ç–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Single-file)

```text
my_server.py
‚îú‚îÄ‚îÄ Presentation: @mcp.tool decorators
‚îú‚îÄ‚îÄ Business Logic: function implementations
‚îú‚îÄ‚îÄ Data Access: httpx.AsyncClient
‚îî‚îÄ‚îÄ Transport: mcp.run()
```

```python
# my_server.py
from fastmcp import FastMCP, Context
import httpx

mcp = FastMCP("Simple Server")

# Data Access Layer
_api_client = httpx.AsyncClient(base_url="https://api.example.com")

# Utils
def validate_input(value: str) -> bool:
    return len(value) >= 3

# Presentation Layer
@mcp.tool
async def get_data(resource_id: int, ctx: Context | None = None) -> dict:
    """Get data from external API."""
    if ctx:
        await ctx.info(f"Fetching resource {resource_id}")

    if resource_id < 1:
        raise ValueError("Invalid resource_id")

    response = await _api_client.get(f"/resources/{resource_id}")
    return response.json()

# Transport Layer
if __name__ == "__main__":
    mcp.run()
```

---

### –ú–æ–¥—É–ª—å–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ (Multi-file)

```text
src/
‚îú‚îÄ‚îÄ server.py              # Main entry point
‚îú‚îÄ‚îÄ presentation/
‚îÇ   ‚îú‚îÄ‚îÄ tools.py           # @mcp.tool definitions
‚îÇ   ‚îú‚îÄ‚îÄ resources.py       # @mcp.resource definitions
‚îÇ   ‚îî‚îÄ‚îÄ prompts.py         # @mcp.prompt definitions
‚îú‚îÄ‚îÄ business_logic/
‚îÇ   ‚îú‚îÄ‚îÄ middleware.py      # Auth, logging, validation
‚îÇ   ‚îú‚îÄ‚îÄ pipelines.py       # Multi-step workflows
‚îÇ   ‚îî‚îÄ‚îÄ transformers.py    # Data transformation
‚îú‚îÄ‚îÄ data_access/
‚îÇ   ‚îú‚îÄ‚îÄ clients.py         # HTTP/DB clients
‚îÇ   ‚îî‚îÄ‚îÄ auth.py            # Authentication handlers
‚îî‚îÄ‚îÄ utils/
    ‚îú‚îÄ‚îÄ formatters.py      # Pure functions
    ‚îî‚îÄ‚îÄ validators.py      # Input validation
```

**server.py (Entrypoint):**

```python
from fastmcp import FastMCP
from src.presentation import tools, resources
from src.business_logic.middleware import LoggingMiddleware, AuthMiddleware
from src.data_access.clients import get_api_client

# Initialize server
mcp = FastMCP("Production Server")

# Add middleware (business logic layer)
mcp.add_middleware(LoggingMiddleware())
mcp.add_middleware(AuthMiddleware())

# Initialize data access
api_client = get_api_client()

# Register components (presentation layer)
tools.register_all(mcp, api_client)
resources.register_all(mcp, api_client)

# Transport
if __name__ == "__main__":
    mcp.run(transport="http", port=8000)
```

**presentation/tools.py:**

```python
from fastmcp import FastMCP, Context

def register_all(mcp: FastMCP, api_client):
    """Register all tools."""

    @mcp.tool
    async def search(query: str, ctx: Context | None = None) -> dict:
        """Search resources."""
        from src.business_logic.pipelines import search_pipeline

        return await search_pipeline(
            query=query,
            client=api_client,
            ctx=ctx
        )
```

**business_logic/pipelines.py:**

```python
from fastmcp import Context

async def search_pipeline(
    query: str,
    client,
    ctx: Context | None = None
) -> dict:
    """Multi-step search pipeline."""
    results = {}

    # Step 1: Search
    if ctx:
        await ctx.info("Step 1: Searching...")

    search_results = await client.post(
        "/search",
        json={"query": query}
    )
    results["search"] = search_results.json()

    # Step 2: Analyze with LLM
    if ctx:
        await ctx.info("Step 2: Analyzing...")

        analysis = await ctx.sample(
            messages=f"Analyze search results: {results['search']}",
            temperature=0.3
        )
        results["analysis"] = analysis.text

    return results
```

---

## ‚ùå –ß—Ç–æ –ù–ï –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)

### Controllers ‚Üí –ù–ï –ù–£–ñ–ù–´

FastMCP Tools —É–∂–µ —è–≤–ª—è—é—Ç—Å—è entry points (–∫–∞–∫ –∫–æ–Ω—Ç—Ä–æ–ª–ª–µ—Ä—ã –≤ REST API).

```python
# ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö - –∏–∑–ª–∏—à–Ω—è—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è
class SearchController:
    def __init__(self, service: SearchService):
        self.service = service

    def handle_search(self, request: SearchRequest) -> SearchResponse:
        return self.service.search(request.query)

# ‚úÖ –î–ï–õ–ê–ô –¢–ê–ö - Tools = Controllers
@mcp.tool
async def search(query: str) -> dict:
    """Direct and simple."""
    response = await _client.post("/search", json={"query": query})
    return response.json()
```

---

### Services ‚Üí –ó–ê–ú–ï–ù–Ø–Æ–¢–°–Ø –Ω–∞ Pipelines

```python
# ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö - OOP overhead
class SearchService:
    def __init__(self, repo: SearchRepository):
        self.repo = repo

    def search(self, query: str) -> List[Result]:
        results = self.repo.search(query)
        return self._filter(results)

# ‚úÖ –î–ï–õ–ê–ô –¢–ê–ö - Functional composition
async def search_pipeline(query: str, ctx: Context) -> dict:
    """Pipeline function instead of Service class."""
    results = await _client.post("/search", json={"query": query})
    filtered = filter_results(results.json())

    if ctx:
        analysis = await ctx.sample(f"Analyze: {filtered}")
        return {"results": filtered, "analysis": analysis.text}

    return {"results": filtered}
```

---

### Repositories ‚Üí HTTP Clients –Ω–∞–ø—Ä—è–º—É—é

```python
# ‚ùå –ù–ï –î–ï–õ–ê–ô –¢–ê–ö - –∏–∑–ª–∏—à–Ω—è—è –∞–±—Å—Ç—Ä–∞–∫—Ü–∏—è –¥–ª—è REST API
class SearchRepository:
    def __init__(self, client: httpx.AsyncClient):
        self.client = client

    def search(self, query: str) -> List[Document]:
        response = self.client.post("/search", json={"query": query})
        return response.json()

# ‚úÖ –î–ï–õ–ê–ô –¢–ê–ö - Direct HTTP client
_client = httpx.AsyncClient(base_url="https://api.example.com")

@mcp.tool
async def search(query: str) -> dict:
    response = await _client.post("/search", json={"query": query})
    return response.json()
```

---

## üü° –ö–æ–≥–¥–∞ –∫–ª–∞—Å—Å—ã –£–ú–ï–°–¢–ù–´

### Service Pattern - –¥–ª—è —Å–ª–æ–∂–Ω–æ–π domain logic

```python
# ‚úÖ –£–ú–ï–°–¢–ù–û: Complex domain logic —Å–æ state
class GraphAnalysisService:
    """Service –¥–ª—è complex graph algorithms."""

    def __init__(self, ctx: Context):
        self.ctx = ctx
        self._graph_cache = {}

    async def analyze_community_structure(
        self,
        collection_id: str
    ) -> dict:
        """Complex multi-step graph analysis."""
        entities = await self._fetch_entities(collection_id)
        graph = self._build_graph(entities)
        communities = self._leiden_algorithm(graph)

        analysis = await self.ctx.sample(
            f"Analyze communities: {communities}"
        )

        return {
            "communities": communities,
            "analysis": analysis.text
        }

    def _build_graph(self, entities):
        import networkx as nx
        # Complex graph building logic
        ...

    def _leiden_algorithm(self, graph):
        # Complex community detection
        ...
```

**–ò—Å–ø–æ–ª—å–∑—É–π Service –¢–û–õ–¨–ö–û –µ—Å–ª–∏:**
- ‚úÖ –°–ª–æ–∂–Ω–∞—è domain logic —Å state
- ‚úÖ –ö–æ–º–ø–æ–∑–∏—Ü–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –°–ª–æ–∂–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã (graph analysis, ML inference)

---

### Repository Pattern - –¥–ª—è complex data access

```python
# ‚úÖ –£–ú–ï–°–¢–ù–û: Multiple data sources —Å fallback
class MultiSourceRepository:
    """Repository –¥–ª—è complex data access patterns."""

    def __init__(
        self,
        primary_client: httpx.AsyncClient,
        fallback_client: httpx.AsyncClient
    ):
        self.primary = primary_client
        self.fallback = fallback_client
        self._cache = {}

    async def search_with_fallback(self, query: str) -> dict:
        """Search with caching and fallback."""
        # Check cache
        if query in self._cache:
            return self._cache[query]

        # Try primary
        try:
            result = await self.primary.post("/search", json={"query": query})
            self._cache[query] = result.json()
            return result.json()
        except httpx.HTTPError:
            pass

        # Fallback to secondary
        result = await self.fallback.post("/search", json={"query": query})
        return result.json()
```

**–ò—Å–ø–æ–ª—å–∑—É–π Repository –¢–û–õ–¨–ö–û –µ—Å–ª–∏:**
- ‚úÖ Multiple data sources —Å fallback logic
- ‚úÖ Complex caching strategies
- ‚úÖ Database access (PostgreSQL, MongoDB)

---

## üìä –°—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Ç–∞–±–ª–∏—Ü–∞

| –ü–∞—Ç—Ç–µ—Ä–Ω | Traditional Backend | FastMCP | –ö–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å |
|---------|---------------------|---------|-------------------|
| **Controllers** | ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | ‚ùå –ù–ï –Ω—É–∂–Ω—ã | –ù–ò–ö–û–ì–î–ê (–µ—Å—Ç—å Tools) |
| **Services** | ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | üü° –†–µ–¥–∫–æ | –°–ª–æ–∂–Ω–∞—è domain logic |
| **Repositories** | ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ | üü° –†–µ–¥–∫–æ | Multiple data sources |
| **Pipelines** | ‚ùå –†–µ–¥–∫–æ | ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π | Multi-step workflows |
| **Middleware** | üü° –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ | ‚úÖ –û—Å–Ω–æ–≤–Ω–æ–π | Cross-cutting concerns |
| **Utils** | ‚úÖ –í—Å–µ–≥–¥–∞ | ‚úÖ –í—Å–µ–≥–¥–∞ | Pure functions |

---

## ‚úÖ –õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏

### –ü–æ —Å–ª–æ—è–º

**Presentation Layer:**
- ‚úÖ –î–µ—Ç–∞–ª—å–Ω—ã–µ docstrings
- ‚úÖ –°—Ç—Ä–æ–≥–∞—è —Ç–∏–ø–∏–∑–∞—Ü–∏—è
- ‚úÖ –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π Context: `ctx: Context | None = None`
- ‚úÖ –ú–∏–Ω–∏–º—É–º –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∏
- ‚ùå –ü—Ä—è–º—ã–µ HTTP/DB –∑–∞–ø—Ä–æ—Å—ã

**Business Logic Layer:**
- ‚úÖ Pipeline functions –¥–ª—è multi-step
- ‚úÖ Middleware –¥–ª—è cross-cutting concerns
- ‚úÖ Context –¥–ª—è dependency injection
- ‚úÖ Async/await –¥–ª—è I/O
- ‚ùå –°–ª–æ–∂–Ω—ã–µ class hierarchies

**Data Access Layer:**
- ‚úÖ Request-time authentication (DynamicBearerAuth)
- ‚úÖ Async HTTP clients
- ‚úÖ Error handling –∏ retry logic
- ‚ùå Module-level credentials
- ‚ùå –°–∏–Ω—Ö—Ä–æ–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç—ã

---

## üéØ –ü—Ä–∞–≤–∏–ª–æ –≤—ã–±–æ—Ä–∞ –ø–æ–¥—Ö–æ–¥–∞

```python
# 1. –ü—Ä–æ—Å—Ç–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è (1-5 —Å—Ç—Ä–æ–∫) ‚Üí –ø—Ä—è–º–æ–π –∫–æ–¥
@mcp.tool
async def simple_op(param: str) -> dict:
    return await _client.get(f"/api/{param}")

# 2. Multi-step (2-5 —à–∞–≥–æ–≤) ‚Üí pipeline function
@mcp.tool
async def complex_op(param: str, ctx: Context) -> dict:
    return await my_pipeline(param, ctx)

# 3. –û—á–µ–Ω—å —Å–ª–æ–∂–Ω–∞—è logic (>100 —Å—Ç—Ä–æ–∫, state) ‚Üí Service class
@mcp.tool
async def very_complex_op(param: str, ctx: Context) -> dict:
    service = ComplexService(ctx)
    return await service.do_complex_thing(param)
```

---

## üöÄ –≠–≤—Ä–∏—Å—Ç–∏–∫–∞ –≤—ã–±–æ—Ä–∞

```text
–û–ø–µ—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ 1-5 —Å—Ç—Ä–æ–∫?
  ‚Üí –ü—Ä—è–º–æ–π –∫–æ–¥ –≤ tool

–û–ø–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç 2-5 —à–∞–≥–æ–≤?
  ‚Üí Pipeline function

–û–ø–µ—Ä–∞—Ü–∏—è —Ç—Ä–µ–±—É–µ—Ç state, —Å–ª–æ–∂–Ω—ã–µ –∞–ª–≥–æ—Ä–∏—Ç–º—ã, >100 —Å—Ç—Ä–æ–∫?
  ‚Üí Service class

–†–∞–±–æ—Ç–∞–µ—à—å —Å –≤–Ω–µ—à–Ω–∏–º API?
  ‚Üí HTTP client –Ω–∞–ø—Ä—è–º—É—é

–†–∞–±–æ—Ç–∞–µ—à—å —Å –ë–î + –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏–µ + fallback?
  ‚Üí Repository pattern
```

---

## üìù –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

### –î–ª—è 90% FastMCP –ø—Ä–æ–µ–∫—Ç–æ–≤:

```text
‚úÖ –ò—Å–ø–æ–ª—å–∑—É–π:
- Tools/Resources/Prompts (–≤–º–µ—Å—Ç–æ controllers)
- Pipeline functions (–≤–º–µ—Å—Ç–æ services)
- HTTP Clients –Ω–∞–ø—Ä—è–º—É—é (–≤–º–µ—Å—Ç–æ repositories)
- Middleware (–¥–ª—è cross-cutting)
- Utils (–¥–ª—è helpers)

‚ùå –ù–ï –∏—Å–ø–æ–ª—å–∑—É–π:
- Controllers (–µ—Å—Ç—å Tools)
- Service classes (–µ—Å—Ç—å Pipeline functions)
- Repository classes (–¥–ª—è –ø—Ä–æ—Å—Ç—ã—Ö REST API)
- DTO classes (–µ—Å–ª–∏ –Ω–µ –Ω—É–∂–Ω–∞ —Å–ª–æ–∂–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è)
```

### –î–ª—è —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–æ–µ–∫—Ç–æ–≤ (10%):

```text
üü° –ú–æ–∂–µ—à—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å:
- Service classes (–¥–ª—è complex domain logic)
- Repository pattern (–¥–ª—è multiple data sources)
- Dependency injection (—á–µ—Ä–µ–∑ Context –∏–ª–∏ globals)
```

---

## üéì –ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è

**FastMCP favors functional composition over object hierarchies.**

–ò—Å–ø–æ–ª—å–∑—É–π –∫–ª–∞—Å—Å—ã –¢–û–õ–¨–ö–û –∫–æ–≥–¥–∞ —Ñ—É–Ω–∫—Ü–∏–π –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ. –í 90% —Å–ª—É—á–∞–µ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ + pipelines + middleware –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–ª—è —ç–ª–µ–≥–∞–Ω—Ç–Ω–æ–≥–æ –∏ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º–æ–≥–æ –∫–æ–¥–∞.

---

## üìö –°–º. —Ç–∞–∫–∂–µ

- [Tools](./02-tools.md) - –°–æ–∑–¥–∞–Ω–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤ –¥–ª—è LLM
- [Middleware](./07-middleware-error-handling.md) - Cross-cutting concerns
- [Deployment](./06-deployment-configuration.md) - Production patterns
- [FastAPI Integration](./08-fastapi-openapi.md) - OpenAPI auto-generation
